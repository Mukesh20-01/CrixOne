rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function isServerTimestamp() {
      return request.time == request.resource.data.__name__;
    }

    function getServerTimestamp() {
      return request.time;
    }

    // ==========================================
    // MATCHES - Public read, no client writes
    // ==========================================
    match /matches/{matchId} {
      // Anyone can read matches
      allow read: if true;
      // Only Cloud Functions can write (verified via custom claims)
      allow write: if false;
    }

    // ==========================================
    // USERS - Private documents
    // ==========================================
    match /users/{uid} {
      // Users can only read their own document
      allow read: if isUser(uid);
      
      // Users can write limited fields (not points or crowns)
      allow create: if isUser(uid) && 
        request.resource.data.uid == uid &&
        request.resource.data.createdAt == request.time &&
        !('points' in request.resource.data) &&
        !('crowns' in request.resource.data) &&
        !('xp' in request.resource.data);
      
      // Users can update specific fields (not points, crowns, xp)
      allow update: if isUser(uid) &&
        !('points' in request.resource.data.diff.delta) &&
        !('crowns' in request.resource.data.diff.delta) &&
        !('xp' in request.resource.data.diff.delta) &&
        !('uid' in request.resource.data.diff.delta) &&
        !('createdAt' in request.resource.data.diff.delta);

      allow delete: if false;
    }

    // ==========================================
    // PREDICTIONS - Users write their own
    // ==========================================
    match /predictions/{matchId}/{uid} {
      allow read: if isUser(uid);
      
      allow create: if isUser(uid) &&
        request.resource.data.uid == uid &&
        request.resource.data.matchId == matchId &&
        request.resource.data.submittedAt == request.time &&
        !('totalPredictionPoints' in request.resource.data) &&
        !('points' in request.resource.data);

      allow update: if isUser(uid) &&
        !('totalPredictionPoints' in request.resource.data.diff.delta) &&
        !('points' in request.resource.data.diff.delta) &&
        !('uid' in request.resource.data.diff.delta) &&
        !('matchId' in request.resource.data.diff.delta);

      allow delete: if false;
    }

    // ==========================================
    // GLOBAL BATTLES - Users write their own
    // ==========================================
    match /battles/{matchId}/global/{uid} {
      allow read: if true;
      
      allow create: if isUser(uid) &&
        request.resource.data.uid == uid &&
        request.resource.data.matchId == matchId &&
        request.resource.data.submittedAt == request.time &&
        !('points' in request.resource.data) &&
        !('rank' in request.resource.data);

      allow update: if isUser(uid) &&
        !('points' in request.resource.data.diff.delta) &&
        !('rank' in request.resource.data.diff.delta) &&
        !('uid' in request.resource.data.diff.delta);

      allow delete: if false;
    }

    // ==========================================
    // PRIVATE BATTLES - Users write their own
    // ==========================================
    match /battles/{matchId}/private/{roomId}/{uid} {
      allow read: if isUser(uid);
      
      allow create: if isUser(uid) &&
        request.resource.data.uid == uid &&
        request.resource.data.matchId == matchId &&
        request.resource.data.roomId == roomId &&
        request.resource.data.submittedAt == request.time &&
        !('points' in request.resource.data) &&
        !('rank' in request.resource.data);

      allow update: if isUser(uid) &&
        !('points' in request.resource.data.diff.delta) &&
        !('uid' in request.resource.data.diff.delta);

      allow delete: if false;
    }

    // ==========================================
    // ROOMS - Users create and read
    // ==========================================
    match /rooms/{roomId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.roomId == roomId &&
        request.auth.uid in request.resource.data.participants;

      allow update: if isUser(resource.data.createdBy) &&
        request.resource.data.createdAt == resource.data.createdAt &&
        !('createdBy' in request.resource.data.diff.delta);

      allow delete: if false;
    }

    // ==========================================
    // LEADERBOARDS - Public read, no client writes
    // ==========================================
    match /leaderboards/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // ==========================================
    // NOTIFICATIONS - Users read their own
    // ==========================================
    match /notifications/{uid}/{notificationId} {
      allow read: if isUser(uid);
      allow write: if false;
    }

    // ==========================================
    // DEFAULT - Deny all
    // ==========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
